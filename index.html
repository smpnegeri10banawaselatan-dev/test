<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rekap Data Kecamatan - Donggala</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; }
  #kecamatan-list li { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.2s; }
  #kecamatan-list li.active, #kecamatan-list li:hover { background-color: #e0f2fe; color: #0369a1; }
  #data-content { overflow-x: auto; }
  .btn { @apply px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm inline-flex items-center gap-1; }
</style>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- Sidebar kiri -->
  <nav class="w-64 bg-white p-4 border-r border-gray-200 shadow-sm h-screen sticky top-0">
    <h2 class="text-xl font-semibold mb-4">Kecamatan</h2>
    <ul id="kecamatan-list" class="space-y-1">     
      <li data-kecamatan="Banawa" data-endpoint="">Kecamatan Banawa</li>
      <li data-kecamatan="Banawa Tengah" data-endpoint="">Kecamatan Banawa Tengah</li>
      <li data-kecamatan="Banawa Selatan" data-endpoint="">Kecamatan Banawa Selatan</li>
      <li data-kecamatan="Rio Pakava" data-endpoint="">Kecamatan Rio Pakava</li>
      <li data-kecamatan="Pinembani" data-endpoint="">Kecamatan Pinembani</li>
      <li data-kecamatan="Tanantovea" data-endpoint="">Kecamatan Tanantovea</li>
      <li data-kecamatan="Labuan" data-endpoint="">Kecamatan Labuan</li>
      <li data-kecamatan="Sindue" data-endpoint="">Kecamatan Sindue</li>
      <li data-kecamatan="Sindue Tombusabora" data-endpoint="">Kecamatan Sindue Tombusabora</li>
      <li data-kecamatan="Sindue Tobata" data-endpoint="">Kecamatan Sindue Tobata</li>
      <li data-kecamatan="Sirenja" data-endpoint="">Kecamatan Sirenja</li>
      <li data-kecamatan="Balaesang" data-endpoint="">Kecamatan Balaesang</li>
      <li data-kecamatan="Balaesang Tanjung" data-endpoint="">Kecamatan Balaesang Tanjung</li>
      <li data-kecamatan="Dampelas" data-endpoint="">Kecamatan Dampelas</li>
      <li data-kecamatan="Sojol" data-endpoint="">Kecamatan Sojol</li>
      <li data-kecamatan="Sojol Utara" data-endpoint="">Kecamatan Sojol Utara</li>
    </ul>
  </nav>

  <!-- Konten kanan -->
  <div class="flex-1 p-6" id="data-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Rekap Data</h2>
      <button id="download-btn" class="btn"><i class="bi bi-download"></i> Download Excel</button>
    </div>
    <div id="rekap-table" class="overflow-auto bg-white shadow-sm rounded-xl p-4">
      <p class="text-gray-500">Memuat data…</p>
    </div>
  </div>

<script>
const items = document.querySelectorAll('#kecamatan-list li');
const content = document.getElementById('rekap-table');
const downloadBtn = document.getElementById('download-btn');

const allowedColumns = [
  "Urut", "Pengguna Barang",
  "Kode Barang", "Nama Barang", "Konfirmasi Keberadaan", "Kondisi",
  "Label BMD (selain Kendaraan)", "Penggunaan", "Nama Pengguna (Jika Penggunaan : Digunakan Pegawai)",
  "Status Pegawai Pengguna (Jika Penggunaan : Digunakan Pegawai)",
  "Keterangan Tambahan", "NIBAR", "Merek/tipe", "Nomor Polisi", "Nomor Rangka",
  "Nomor BPKB", "Nilai Perolehan", "Cara Perolehan", "Perolehan", "Status Penggunaan"
];

let currentItem = null;
let refreshInterval = null;

function arrayToCSV(data) {
  const header = allowedColumns.join(",");
  const rows = data.map(row => allowedColumns.map(col => `"${(row[col]||'').replace(/"/g,'""')}"`).join(","));
  return [header, ...rows].join("\n");
}

function downloadCSV(data) {
  const csv = arrayToCSV(data);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentItem.dataset.kecamatan || 'Semua'}-data.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function loadData(item) {
  currentItem = item;
  items.forEach(i => i.classList.remove('active'));
  item.classList.add('active');

  const url = item.dataset.endpoint;
  content.innerHTML = `<p class="text-gray-500">Memuat data ${item.dataset.kecamatan || 'Semua'}…</p>`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (!data || data.length === 0) {
        content.innerHTML = `<p class="text-gray-500">Data kosong.</p>`;
        return;
      }

      // Filter kolom
      const table = `<table class="min-w-full border border-gray-200">
        <thead class="bg-gray-100"><tr>${allowedColumns.map(col => `<th class="border px-3 py-2 text-left text-sm font-medium">${col}</th>`).join('')}</tr></thead>
        <tbody>${data.map(row => `<tr class="hover:bg-gray-50">${allowedColumns.map(col => `<td class="border px-3 py-1 text-sm">${row[col]||''}</td>`).join('')}</tr>`).join('')}</tbody>
      </table>`;

      content.innerHTML = table;
      content.dataset.latestData = JSON.stringify(data);
    })
    .catch(err => {
      content.innerHTML = `<p class="text-red-500">Gagal memuat data: ${err}</p>`;
    });
}

// Load data pertama kali
window.addEventListener('DOMContentLoaded', () => {
  const firstItem = document.querySelector('#kecamatan-list li.active');
  if (firstItem) loadData(firstItem);

  // Refresh otomatis setiap 20 detik
  refreshInterval = setInterval(() => {
    if (currentItem) loadData(currentItem);
  }, 20000);
});

// Klik kecamatan
items.forEach(item => {
  item.addEventListener('click', () => loadData(item));
});

// Tombol download
downloadBtn.addEventListener('click', () => {
  if (content.dataset.latestData) {
    const data = JSON.parse(content.dataset.latestData);
    downloadCSV(data);
  } else {
    alert("Data belum siap untuk di-download.");
  }
});
</script>

</body>
</html>
