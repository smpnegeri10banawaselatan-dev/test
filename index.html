<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peralatan dan Mesin — Data dari Google Sheets</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121935; --muted:#8ea0ff; --text:#e7ebff; --accent:#6ea8fe; --border:#223063;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui; background:var(--bg); color:var(--text)}
    header{position:sticky;top:0;background:#0b1020cc;padding:1rem;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:1.5rem}
    input,button{padding:.5rem;border-radius:.5rem;border:1px solid var(--border)}
    input{flex:1;min-width:200px;background:#0f1730;color:var(--text)}
    button{background:var(--accent);color:#000;cursor:pointer}
    main{padding:1rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.5rem;border-bottom:1px solid var(--border);vertical-align:top}
    th{background:#0f1730;color:var(--muted);cursor:pointer;white-space:nowrap}
    tbody tr:hover{background:#0f1730}
  </style>
</head>
<body>
  <header>
    <h1>Peralatan dan Mesin</h1>
    <div style="display:flex;gap:.5rem;margin-top:.5rem">
      <input id="search" type="search" placeholder="Cari…" />
      <button id="download">Unduh CSV</button>
      <button id="reload">Muat ulang</button>
    </div>
  </header>
  <main>
    <div style="overflow:auto">
      <table>
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <p id="status"></p>
  </main>
  <script>
    const ENDPOINT = "https://opensheet.elk.sh/https://docs.google.com/spreadsheets/d/152oNQyrJEeg-xW3okB2LKbGIUapxDakDMCbDjqpDl3U/Peralatan%20dan%20Mesin";
    let columns = [];
    let data = [];

    const thead = document.querySelector('thead');
    const tbody = document.querySelector('tbody');
    const status = document.getElementById('status');
    const search = document.getElementById('search');

    function renderTable(rows){
      thead.innerHTML = '<tr>' + columns.map(c=>`<th>${c.replace(/\n/g,'<br>')}</th>`).join('') + '</tr>';
      tbody.innerHTML = rows.map(r=>'<tr>' + columns.map(c=>`<td>${r[c]||''}</td>`).join('') + '</tr>').join('');
    }

    async function load(){
      status.textContent = 'Memuat data…';
      try{
        const res = await fetch(ENDPOINT);
        if(!res.ok) throw new Error(res.statusText);
        data = await res.json();
        // ambil semua kolom dari baris pertama
        columns = Object.keys(data[0] || {});
        renderTable(data);
        status.textContent = `${data.length} baris dimuat.`;
      }catch(e){
        status.textContent = 'Gagal memuat data: ' + e.message;
      }
    }

    function filterData(){
      const q = search.value.toLowerCase();
      const filtered = data.filter(row => columns.some(c => (row[c]||'').toLowerCase().includes(q)));
      renderTable(filtered);
    }

    function downloadCSV(){
      const rows = [columns, ...data.map(r => columns.map(c => r[c]||''))];
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'Peralatan_dan_Mesin.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById('reload').onclick = load;
    document.getElementById('download').onclick = downloadCSV;
    search.oninput = filterData;

    load();
  </script>
</body>
</html>
