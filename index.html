<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peralatan dan Mesin — Data dari OpenSheet</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121935; --muted:#8ea0ff; --text:#e7ebff; --accent:#6ea8fe; --border:#223063;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,16,32,.95),rgba(11,16,32,.75));backdrop-filter:saturate(1.4) blur(6px);border-bottom:1px solid var(--border)}
    .container{max-width:1100px;margin:0 auto;padding:1rem 1.25rem}
    h1{margin:0;font-size:clamp(1.1rem,2.6vw,1.6rem);letter-spacing:.2px}
    .controls{display:flex;gap:.75rem;flex-wrap:wrap;margin-top:.75rem}
    input[type="search"]{flex:1;min-width:220px;background:#0f1730;border:1px solid var(--border);color:var(--text);padding:.65rem .8rem;border-radius:.75rem;outline:none}
    button{background:var(--accent);color:#0b1020;border:0;padding:.6rem .9rem;border-radius:.75rem;font-weight:600;cursor:pointer}
    button.ghost{background:#0f1730;color:var(--muted);border:1px solid var(--border)}
    main{padding:1.2rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:1rem;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0f1730;color:var(--muted);text-align:left;font-size:.9rem;border-bottom:1px solid var(--border);padding:.7rem .75rem;white-space:nowrap}
    tbody td{border-bottom:1px solid #1b2652;padding:.7rem .75rem;font-size:.95rem;vertical-align:top}
    tbody tr:hover{background:#0f1730}
    .badge{display:inline-flex;align-items:center;gap:.35rem;font-size:.75rem;padding:.25rem .45rem;border-radius:.5rem;background:#0f1730;border:1px solid var(--border);color:var(--muted)}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:.75rem;padding: .8rem .9rem;border-top:1px solid var(--border);background:#0f1730;color:var(--muted)}
    .spinner{width:22px;height:22px;border:3px solid #1e2b5e;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .empty{padding:2rem;text-align:center;color:var(--muted)}
    .count{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Peralatan dan Mesin <span class="badge"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>OpenSheet</span></h1>
      <div class="controls">
        <input id="q" type="search" placeholder="Cari… (tekan / untuk fokus)" autocomplete="off" />
        <button id="downloadCsv" class="ghost" type="button">Unduh CSV</button>
        <button id="refresh" type="button">Muat ulang</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div id="status" class="footer"><span class="spinner" aria-hidden="true"></span><span>Memuat data…</span></div>
      <div class="table-wrap" id="tableWrap" hidden>
        <table id="dataTable" aria-describedby="caption">
          <caption id="caption" class="sr-only">Tabel dari OpenSheet</caption>
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="empty" class="empty" hidden>Tidak ada data yang cocok.</div>
      <div class="footer"><span><strong id="count" class="count">0</strong> baris</span><span id="lastUpdated"></span></div>
    </div>
  </main>

  <script>
    const ENDPOINT = "https://opensheet.elk.sh/https%3A%2F%2Fdocs.google.com%2Fspreadsheets%2Fd%2F152oNQyrJEeg-xW3okB2LKbGIUapxDakDMCbDjqpDl3U%2Fedit%3Fgid%3D1366865323%23gid%3D1366865323/Peralatan%20dan%20Mesin";

    const el = {
      q: document.getElementById('q'),
      tableWrap: document.getElementById('tableWrap'),
      thead: document.querySelector('#dataTable thead'),
      tbody: document.querySelector('#dataTable tbody'),
      status: document.getElementById('status'),
      empty: document.getElementById('empty'),
      count: document.getElementById('count'),
      lastUpdated: document.getElementById('lastUpdated'),
      refresh: document.getElementById('refresh'),
      downloadCsv: document.getElementById('downloadCsv'),
    };

    let rawData = [];
    let columns = [];

    // Helpers
    const sanitize = (v) => (v === null || v === undefined) ? '' : String(v);

    function autoColumns(rows){
      const set = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => set.add(k)));
      return Array.from(set);
    }

    function renderTable(rows){
      // header
      el.thead.innerHTML = '';
      const trh = document.createElement('tr');
      columns.forEach((c, idx) => {
        const th = document.createElement('th');
        th.textContent = c;
        th.tabIndex = 0;
        th.title = 'Klik untuk urutkan';
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => sortBy(c));
        th.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'||ev.key===' '){ sortBy(c); ev.preventDefault(); }});
        trh.appendChild(th);
      });
      el.thead.appendChild(trh);

      // body
      el.tbody.innerHTML = '';
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        columns.forEach(c => {
          const td = document.createElement('td');
          td.textContent = sanitize(r[c]);
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      });
      el.tbody.appendChild(frag);

      el.count.textContent = rows.length.toLocaleString('id-ID');
      el.empty.hidden = rows.length !== 0;
      el.tableWrap.hidden = rows.length === 0;
    }

    let sortState = { key:null, dir:1 };
    function sortBy(key){
      const dir = (sortState.key === key) ? -sortState.dir : 1;
      sortState = { key, dir };
      const sorted = [...filtered()].sort((a,b)=>{
        const av = sanitize(a[key]).toLowerCase();
        const bv = sanitize(b[key]).toLowerCase();
        if(!isNaN(+av) && !isNaN(+bv)) return (Number(av)-Number(bv)) * dir;
        return av.localeCompare(bv,'id') * dir;
      });
      renderTable(sorted);
    }

    function filtered(){
      const q = el.q.value.trim().toLowerCase();
      if(!q) return rawData;
      return rawData.filter(r => columns.some(c => sanitize(r[c]).toLowerCase().includes(q)));
    }

    async function load(){
      try{
        el.status.innerHTML = '<span class="spinner" aria-hidden="true"></span><span>Memuat data…</span>';
        el.status.hidden = false;
        const res = await fetch(ENDPOINT, { headers: { 'Accept':'application/json' } });
        if(!res.ok) throw new Error('Gagal memuat: ' + res.status + ' ' + res.statusText);
        const data = await res.json();
        rawData = Array.isArray(data) ? data : [];
        columns = autoColumns(rawData);
        renderTable(filtered());
        el.status.hidden = true;
        el.lastUpdated.textContent = 'Sumber: OpenSheet — ' + new Date().toLocaleString('id-ID');
      }catch(err){
        console.error(err);
        el.status.innerHTML = '<span>⚠️ ' + err.message + '</span>';
      }
    }

    // CSV download
    function toCsv(rows){
      const header = columns.map(h => '"' + h.replaceAll('"','""') + '"').join(',');
      const body = rows.map(r => columns.map(c => '"' + sanitize(r[c]).replaceAll('"','""') + '"').join(',')).join('\n');
      return header + (body ? '\n' + body : '');
    }

    function downloadCsv(){
      const rows = filtered();
      const blob = new Blob([\n"\ufeff" + toCsv(rows)], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:'Peralatan_dan_Mesin.csv' });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // events
    el.q.addEventListener('input', () => renderTable(filtered()));
    el.refresh.addEventListener('click', load);
    el.downloadCsv.addEventListener('click', downloadCsv);
    window.addEventListener('keydown', (e)=>{ if(e.key==='/' && document.activeElement !== el.q){ e.preventDefault(); el.q.focus(); }});

    // go!
    load();
  </script>
</body>
</html>
