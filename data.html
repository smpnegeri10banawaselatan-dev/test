<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peralatan dan Mesin — Data dari Google Sheets</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121935; --muted:#8ea0ff; --text:#e7ebff; --accent:#6ea8fe; --border:#223063;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui; background:var(--bg); color:var(--text); display:flex; min-height:100vh;}
    nav{width:200px; background:#121935; padding:1rem; border-right:1px solid var(--border);}
    nav h2{margin-top:0; font-size:1.2rem; color:var(--accent);}
    nav ul{list-style:none; padding:0; margin:0;}
    nav li{padding:.5rem; cursor:pointer; border-radius:.3rem;}
    nav li:hover{background:#223063;}
    main{flex:1; display:flex; flex-direction:column; padding:1rem; overflow:auto;}
    header{background:#0b1020cc;padding:1rem;border-bottom:1px solid var(--border); display:flex; flex-direction:column;}
    header h1{margin:0;font-size:1.5rem;}
    .controls{display:flex;gap:.5rem;margin-top:.5rem;}
    input,button{padding:.5rem;border-radius:.5rem;border:1px solid var(--border);}
    input{flex:1;min-width:200px;background:#0f1730;color:var(--text);}
    button{background:var(--accent);color:#000;cursor:pointer;}
    table{width:100%;border-collapse:collapse;margin-top:1rem;}
    th,td{padding:.5rem;border-bottom:1px solid var(--border);vertical-align:top;}
    th{background:#0f1730;color:var(--muted);cursor:pointer;white-space:nowrap;}
    tbody tr:hover{background:#0f1730;}
    #status{margin-top:.5rem;}
  </style>
</head>
<body>
  <nav>
    <h2>Kecamatan</h2>
    <ul id="kecamatan-list">
      <li data-kecamatan="">Semua</li>
      <li data-kecamatan="Banawa">Kecamatan Banawa</li>
      <li data-kecamatan="Banawa Tengah">Kecamatan Banawa Tengah</li>
      <li data-kecamatan="Balanipa">Kecamatan Balanipa</li>
      <li data-kecamatan="Duampanua">Kecamatan Duampanua</li>
      <li data-kecamatan="Marobo">Kecamatan Marobo</li>
      <li data-kecamatan="Labuan">Kecamatan Labuan</li>
      <li data-kecamatan="Tapalang">Kecamatan Tapalang</li>
      <li data-kecamatan="Tapalang Barat">Kecamatan Tapalang Barat</li>
      <li data-kecamatan="Tinambung">Kecamatan Tinambung</li>
      <li data-kecamatan="Tinambung Barat">Kecamatan Tinambung Barat</li>
      <li data-kecamatan="Mapilli">Kecamatan Mapilli</li>
      <li data-kecamatan="Campalagian">Kecamatan Campalagian</li>
      <li data-kecamatan="Luyo">Kecamatan Luyo</li>
      <li data-kecamatan="Wonomulyo">Kecamatan Wonomulyo</li>
      <li data-kecamatan="Polewali">Kecamatan Polewali</li>
      <li data-kecamatan="Anreapi">Kecamatan Anreapi</li>
    </ul>
  </nav>
  <main>
    <header>
      <h1>Peralatan dan Mesin</h1>
      <div class="controls">
        <input id="search" type="search" placeholder="Cari…" />
        <button id="download">Unduh CSV</button>
        <button id="reload">Muat ulang</button>
      </div>
    </header>
    <div style="overflow:auto; flex:1;">
      <table>
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <p id="status"></p>
  </main>

  <script>
    const ENDPOINT = "https://opensheet.elk.sh/152oNQyrJEeg-xW3okB2LKbGIUapxDakDMCbDjqpDl3U/Peralatan%20dan%20Mesin";

    const columns = [
      "Urut","Pengguna Barang","Kode Barang","Nama Barang",
      "Konfirmasi Keberadaan","Kondisi","Label BMD (selain Kendaraan)","Penggunaan",
      "Nama Pengguna (Jika Penggunaan : Digunakan Pegawai)",
      "Status Pegawai Pengguna (Jika Penggunaan : Digunakan Pegawai)",
      "Keterangan Tambahan","NIBAR","Merek/tipe","Nomor Polisi","Nomor Rangka","Nomor BPKB",
      "Nilai Perolehan","Cara Perolehan","Perolehan","Status Penggunaan"
    ];

    const thead = document.querySelector('thead');
    const tbody = document.querySelector('tbody');
    const status = document.getElementById('status');
    const search = document.getElementById('search');
    const kecamatanList = document.getElementById('kecamatan-list');

    let data = [];
    let currentKecamatan = "";

    function renderTable(rows){
      thead.innerHTML = '<tr>' + columns.map(c=>`<th>${c.replace(/\n/g,'<br>')}</th>`).join('') + '</tr>';
      tbody.innerHTML = rows.map(r=>'<tr>' + columns.map(c=>`<td>${r[c]||''}</td>`).join('') + '</tr>').join('');
    }

    async function load(){
      status.textContent = 'Memuat data…';
      try{
        const res = await fetch(ENDPOINT);
        if(!res.ok) throw new Error(res.statusText);
        data = await res.json();
        applyFilters();
      }catch(e){
        status.textContent = 'Gagal memuat data: ' + e.message;
      }
    }

    function applyFilters(){
      const q = search.value.toLowerCase();
      let filtered = data;

      if(currentKecamatan){
        filtered = filtered.filter(row => (row['Pengguna Barang']||'').toLowerCase().includes(currentKecamatan.toLowerCase()));
      }

      if(q){
        filtered = filtered.filter(row => columns.some(c => (row[c]||'').toLowerCase().includes(q)));
      }

      renderTable(filtered);
      status.textContent = `${filtered.length} baris ditampilkan. Terakhir diperbarui: ${new Date().toLocaleTimeString()}`;
    }

    search.oninput = applyFilters;

    kecamatanList.querySelectorAll('li').forEach(li => {
      li.onclick = () => {
        currentKecamatan = li.dataset.kecamatan;
        applyFilters();
      };
    });

    function downloadCSV(){
      const rows = [columns, ...data.map(r => columns.map(c => r[c]||''))];
      const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'Peralatan_dan_Mesin.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById('reload').onclick = load;
    document.getElementById('download').onclick = downloadCSV;

    load();
    setInterval(load, 10000); // Update otomatis setiap 10 detik
  </script>
</body>
</html>
